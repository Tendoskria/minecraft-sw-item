<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div class="container">
    <header>
      <h1>Item event SW</h1>
    </header>

    <nav class="breadcrumb">
      <a href="/">Accueil</a> / Ajout
    </nav>

    <div class="admin-tabs">
      <button class="tab-btn active" data-tab="event">Créer un event</button>
      <button class="tab-btn" data-tab="item">Créer un item</button>
      <button class="tab-btn" data-tab="enchantment">Créer un enchantement</button>
    </div>

    <!-- Tab Event -->
    <div class="tab-content active" id="tab-event">
      <h2>Nouvel Event</h2>
      <form action="/admin/event" method="POST" class="admin-form">
        <div class="form-group">
          <label>Nom de l'event</label>
          <input type="text" name="eventName" required placeholder="Ex: Noel, Halloween">
        </div>
        <div class="form-group">
          <label>Année</label>
          <input type="text" name="year" required placeholder="2025" maxlength="4">
        </div>
        <button type="submit" class="btn-submit">Créer l'event</button>
      </form>
    </div>

    <!-- Tab Item -->
    <div class="tab-content" id="tab-item">
      <h2>Nouvel item</h2>
      <form action="/admin/item" method="POST" class="admin-form" id="item-form">
        <div class="form-group">
          <label>Nom de l'item</label>
          <input type="text" name="itemName" required>
        </div>
        <div class="form-group">
          <label>Item Vanilla</label>
          <div class="autocomplete-wrapper">
            <input type="text" id="vanilla-item-search" placeholder="Rechercher un item vanilla..." autocomplete="off">
            <input type="hidden" name="vanillaItem" id="vanilla-item-id">
            <div class="autocomplete-results" id="vanilla-autocomplete"></div>
          </div>
        </div>
        <div class="form-group">
          <label>Event associé</label>
          <select name="eventId" required>
            <option value="">Sélectionner un event</option>
            <% events.forEach(event=> { %>
              <option value="<%= event.id %>">
                <%= event.event_name %>
                  <%= event.year %>
              </option>
              <% }); %>
          </select>
        </div>
        <div class="form-group">
          <label>Catégorie</label>
          <select name="category">
            <option value="RecompenseEvent">Récompense event</option>
            <option value="Caisse">Caisse</option>
            <option value="Quetes">Quetes</option>
            <option value="Autres">Autres</option>
          </select>
        </div>
        <div class="form-group">
          <label>Enchantements</label>
          <div class="enchantment-list" id="enchantment-pills">
            <button type="button" class="btn-add-ench" id="add-ench-btn">+</button>
          </div>
          <textarea name="enchantments" id="enchantments-textarea" style="display: none;"></textarea>
        </div>
        <button type="submit" class="btn-submit">Créer l'item</button>
      </form>
    </div>

    <!-- Tab Enchantement -->
    <div class="tab-content" id="tab-enchantment">
      <h2>Nouvel enchantement</h2>
      <form action="/admin/enchantment" method="POST" class="admin-form">
        <div class="form-group">
          <label>Nom de l'enchantement</label>
          <input type="text" name="enchantmentName" required>
        </div>
        <button type="submit" class="btn-submit">Créer l'enchantement</button>
      </form>
    </div>
  </div>

  <!-- Modal pour ajouter enchantement (HORS du formulaire) -->
  <div class="modal" id="enchantment-modal" style="display: none;">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h3>Ajouter un enchantement</h3>
      <div class="modal-enchantment-section">
        <div class="form-row">
          <div class="form-group">
            <label>Enchantement</label>
            <select id="modal-enchantment-select">
              <option value="">Sélectionner...</option>
              <% enchantments.forEach(ench=> { %>
                <option value="<%= ench.name %>">
                  <%= ench.name %>
                </option>
                <% }); %>
            </select>
          </div>
          <div class="form-group">
            <label>Level</label>
            <input type="number" id="modal-enchantment-level" min="1" max="15" placeholder="2">
          </div>
        </div>
        <button type="button" class="btn-add" id="modal-add-btn">Ajouter</button>
      </div>
    </div>
  </div>

  <script>
    // Gestion des tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });

    // Gestion du modal d'enchantement
    const addEnchBtn = document.getElementById('add-ench-btn');
    const enchModal = document.getElementById('enchantment-modal');
    const modalClose = document.querySelector('.modal-close');
    const modalAddBtn = document.getElementById('modal-add-btn');
    const enchantmentPills = document.getElementById('enchantment-pills');
    const enchantmentsTextarea = document.getElementById('enchantments-textarea');

    let selectedEnchantments = [];

    // Ouvrir le modal
    if (addEnchBtn) {
      addEnchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Opening modal...');
        enchModal.style.display = 'flex';
      });
    }

    // Fermer le modal avec X
    if (modalClose) {
      modalClose.addEventListener('click', () => {
        enchModal.style.display = 'none';
      });
    }

    // Fermer le modal en cliquant à l'extérieur
    if (enchModal) {
      enchModal.addEventListener('click', (e) => {
        if (e.target === enchModal) {
          enchModal.style.display = 'none';
        }
      });
    }

    // Ajouter un enchantement
    if (modalAddBtn) {
      modalAddBtn.addEventListener('click', () => {
        const enchSelect = document.getElementById('modal-enchantment-select');
        const levelInput = document.getElementById('modal-enchantment-level');

        const enchName = enchSelect.value;
        const enchLevel = levelInput.value;

        if (!enchName) {
          alert('Veuillez sélectionner un enchantement');
          return;
        }

        // Ajouter à la liste
        const enchantment = {
          name: enchName,
          level: enchLevel || null
        };

        selectedEnchantments.push(enchantment);
        updateEnchantmentPills();
        updateEnchantmentsTextarea();

        // Fermer le modal et réinitialiser
        enchModal.style.display = 'none';
        enchSelect.value = '';
        levelInput.value = '';
      });
    }

    // Mettre à jour les pills
    function updateEnchantmentPills() {
      // Garder le bouton +
      const addBtn = document.getElementById('add-ench-btn');
      enchantmentPills.innerHTML = '';

      selectedEnchantments.forEach((ench, index) => {
        const pill = document.createElement('div');
        pill.className = 'enchantment-pill';
        pill.innerHTML = `
          ${ench.name}${ench.level ? ' ' + ench.level : ''} 
          <button type="button" onclick="removeEnchantment(${index})">×</button>
        `;
        enchantmentPills.appendChild(pill);
      });

      // Remettre le bouton +
      enchantmentPills.appendChild(addBtn);
    }

    // Mettre à jour le textarea caché
    function updateEnchantmentsTextarea() {
      const text = selectedEnchantments
        .map(ench => `${ench.name}${ench.level ? ' ' + ench.level : ''}`)
        .join('\n');
      enchantmentsTextarea.value = text;
    }

    // Supprimer un enchantement
    window.removeEnchantment = function (index) {
      selectedEnchantments.splice(index, 1);
      updateEnchantmentPills();
      updateEnchantmentsTextarea();
    };


    const vanillaItems = <%- JSON.stringify(vanillaItems) %>;

    const searchInput = document.getElementById('vanilla-item-search');
    const resultsBox = document.getElementById('vanilla-autocomplete');
    const hiddenInput = document.getElementById('vanilla-item-id');

    searchInput.addEventListener('input', () => {
      const value = searchInput.value.toLowerCase();
      resultsBox.innerHTML = '';

      if (value.length < 2) {
        resultsBox.style.display = 'none';
        return;
      }

      const matches = vanillaItems
        .filter(item => item.item_name.toLowerCase().includes(value))
        .slice(0, 10);

      if (!matches.length) {
        resultsBox.style.display = 'none';
        return;
      }

      matches.forEach(item => {
        const div = document.createElement('div');
        div.className = 'autocomplete-item';
        div.textContent = item.item_name;

        div.addEventListener('click', () => {
          searchInput.value = item.item_name;
          hiddenInput.value = item.id;
          resultsBox.innerHTML = '';
          resultsBox.style.display = 'none';
        });

        resultsBox.appendChild(div);
      });

      resultsBox.style.display = 'block';
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.autocomplete-wrapper')) {
        resultsBox.style.display = 'none';
      }
    });



  </script>
</body>

</html>